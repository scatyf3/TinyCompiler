# complier

24æ˜¥ åŒ—äº¬å¸ˆèŒƒå¤§å­¦ ç¼–è¯‘å™¨ä½œä¸š



## å®éªŒä¸€: TinyComplier

åˆä»£ç¼–è¯‘å™¨å°† C è¯­è¨€é¡ºåºè¯­å¥åºåˆ—ç¿»è¯‘ä¸ºç­‰ä»·çš„æ±‡ç¼–ç¨‹åºï¼Œæ‰€è¾“å‡ºçš„æ±‡ç¼– ç¨‹åºç¬¦åˆx86æˆ–MIPSæ±‡ç¼–è¯­è¨€æ ¼å¼è¦æ±‚ï¼Œèƒ½å¤Ÿè¢«åç»­çš„æ±‡ç¼–å™¨ç¿»è¯‘ä¸ºå¯æ‰§è¡Œç¨‹ åºè¿è¡Œã€‚å¦‚æœç›®æ ‡å¹³å°ä¸º x86ï¼Œåˆ™ç”Ÿæˆçš„å¯æ‰§è¡Œç¨‹åºèƒ½å¤Ÿåœ¨ç›®æ ‡æœºä¸Šæ‰§è¡Œå’ŒéªŒè¯ç»“æœï¼›å¦‚æœç›®æ ‡å¹³å°ä¸º MIPSï¼Œåˆ™ç”Ÿæˆçš„æ±‡ç¼–ç¨‹åºå¯ä»¥åœ¨ MIPS æ¨¡æ‹Ÿå™¨ä¸­è¿è¡Œå’Œ
éªŒè¯ç»“æœã€‚

è¯¦ç»†çš„è¯´æ˜è§`doc/Lab01WriteUp.md`

## å®éªŒäºŒï¼šæ”¯æŒæ›´å¤æ‚çš„æ–‡æ³•å¤„ç†å’Œprint

è¯¦ç»†çš„è¯´æ˜è§`doc/lab_02_write_up.md`

### å‰ç«¯

- å°†åˆä»£ç¼–è¯‘å™¨çš„å‰ç«¯è½¬åŒ–ä¸ºflex
- æ”¯æŒæ›´å¤šè¿ç®—ç¬¦
- æ”¯æŒè¯†åˆ«`(){}`æ‹¬å·åµŒå¥—
- æ”¯æŒè¯†åˆ«æ ‡å‡†åº“å‡½æ•°`println_int`,`println_string`

### åç«¯

- æ”¯æŒmainå‡½æ•°ä½œä¸ºç¨‹åºå…¥å£
- æ”¯æŒæ‰“å°å‡½æ•°
- æ”¯æŒæ›´å¤šå¤æ‚è¡¨è¾¾å¼æ±‚èŒ

### ä½¿ç”¨è¯´æ˜

åœ¨buildæ–‡ä»¶å¤¹ä¸‹å®Œæˆæ„å»º
- `make` æ„å»ºä¸»ç¨‹åº
- `make test_tokenrizer` ä»testæ–‡ä»¶å¤¹ä¸‹çš„`test_flex_rule.l`æ„å»ºtokenrizerï¼Œæ‰“å°è§£æçš„ç»“æœ
- `make test_compile` ä»testæ–‡ä»¶å¤¹ä¸‹çš„`test_compile.cpp`æ„å»ºä»ç»™å®šçš„tokenç¼–è¯‘ç¨‹åºçš„åç«¯ç¨‹åº
- `sh run_cases_2.sh` è¿è¡Œ`test/cases_2/`æ–‡ä»¶å¤¹ä¸‹çš„å…«ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œç»“æœå‚¨å­˜åœ¨`out/case_2`é‡Œ

## å®éªŒä¸‰

### æœ¯è¯­

- è°ƒç”¨è€…
- è¢«è°ƒç”¨è€…

```sudocode
è¢«è°ƒç”¨è€…(){
    //ä¸€äº›å®šä¹‰
}

è°ƒç”¨è€…(){
    è¢«è°ƒç”¨è€…();
}
```

### æˆ‘çš„å·¥ä½œ

- ç”¨bisonæ”¹å†™åç«¯ï¼Œä»c++è¿ç§»
- æ”¯æŒå‡½æ•°å®šä¹‰å’Œè°ƒç”¨ï¼Œä¸ºäº†æ”¯æŒè¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦çš„å·¥ä½œæœ‰
    - ç»´æŠ¤ä¸€ä¸ªç¬¦å·è¡¨æ ˆå’Œå…¨éƒ¨çš„ç¬¦å·è¡¨
        - æ¯å½“è°ƒç”¨å‡½æ•°æ—¶ï¼Œæ–°å»ºè¢«è°ƒç”¨è€…çš„ç¬¦å·è¡¨å¹¶pushå…¥ç¬¦å·è¡¨æ ˆ
        - æ¯å½“è°ƒç”¨å‡½æ•°è¿”å›æ—¶ï¼Œä»ç¬¦å·è¡¨æ ˆä¸­å¼¹å‡ºè°ƒç”¨è€…çš„ç¬¦å·è¡¨
    - åˆ›å»ºä¸€ä¸ªenumï¼Œç»´æŠ¤ç¬¦å·ç±»å‹ï¼Œ
        - å¦‚æœæ˜¯local varç±»å‹ï¼Œä» fp-4n (n>0) ï¼Œå³å½“å‰æ ˆå¸§å¯»æ‰¾å€¼
        - å¦‚æœæ˜¯func argç±»å‹ï¼Œä»fp+4n (n>0)ï¼Œå³è°ƒç”¨è€…å‹å…¥æ ˆï¼Œä½†æ˜¯ä¸åœ¨å½“å‰æ ˆå¸§çš„åœ°æ–¹å¯»æ‰¾å€¼
        ![alt text](image.png)
    - åœ¨ã€Œåå¤„ç†ã€é˜¶æ®µï¼Œåˆ¤æ–­æ¯ä¸ªæ ˆå¸§åº”è¯¥æœ‰å¤šå¤§ï¼Œå¢åŠ æ¯ä¸ªå‡½æ•°çš„ç¬¦å·

- å¢åŠ ã€Œåå¤„ç†ã€é˜¶æ®µ
    - å¯¹äºæ¯ä¸ªæ ˆå¸§ï¼Œè®°å½•ä½¿ç”¨äº†å¤šå°‘å±€éƒ¨å˜é‡ï¼Œä»¥ç»´æŠ¤ä¸€ä¸ªåˆç†çš„æ ˆå¸§å°ºå¯¸
    - è®°å½•æ–‡ä»¶ä¸­å‡ºç°çš„å…¨éƒ¨å‡½æ•°ï¼Œåœ¨æ±‡ç¼–ç¨‹åºçš„å¼€å§‹å¢åŠ å‡½æ•°çš„`.globl <func name>`


    
#### fix å‡½æ•°æ··åˆè°ƒç”¨é—®é¢˜

```c
void myadd(int a,int b){
    return a+b;
}
int main(){
    println_int(1+myadd(114,514));
    return 0;
}

```

åœ¨è¿™ä¸ªç¤ºä¾‹ç¨‹åºé‡Œï¼Œæˆ‘ä»¬æœŸå¾…çš„ç»“æœæ˜¯629ï¼Œä½†æ˜¯

```sh
âœ  build git:(main) âœ— spim -file ../out/test.asm
Loaded: /opt/homebrew/Cellar/spim/9.1.24/share/exceptions.s
742
```

æ„Ÿè§‰æ˜¯ç”±äºä¼ å‚è§„èŒƒçš„æ··ä¹±é€ æˆçš„

å‡½æ•°è°ƒç”¨å‰

```stack
- 1
- 114
- 514
```

push 114
push 514
pop push
pop push
æ„Ÿè§‰ä¸å¦‚ç›´æ¥push...


push è¿”å›å€¼
eval add
ç»“æœåœ¨stackçš„é¡¶éƒ¨ğŸ˜ 


åœ¨evaléƒ¨åˆ†

```asm
# START OF EVAL

# è¿™é‡Œå°±æ˜¯742äº†ï¼Œå¥‡æ€ª
# t1:628
# t0:114
# å•Šè¿™ï¼Œè¿™é‡Œå¥‡æ€ªäº†
lw $t1, 4($sp)
lw $t0, 8($sp)
add $t0, $t0, $t1
sw $t0, 8($sp)
addiu $sp, $sp, 4
# END OF EVAL
```
å‘ç°ä¼ å‚çš„stackæ²¡æœ‰æ¸…ç†å¹²å‡€ğŸ˜ ï¼

æˆ‘ä»¬æœŸå¾…å‡½æ•°è°ƒç”¨å®Œçš„ç»“æœæ˜¯

```stack
- 1
- 628
```

ä½†æ˜¯æˆ‘ä»¬è¿™é‡Œçš„ç»“æœæ˜¯
```stack
- 1
- 114
- 628
```


#### fix åµŒå¥—è°ƒç”¨

æ®@LuciusåŒå­¦è¯´ï¼Œe04å’Œe07çš„é—®é¢˜æ˜¯åµŒå¥—è°ƒç”¨ï¼Œå¦‚æœ`e09.c`workå°±èƒ½å…¨å¯¹

```
Running testcase: ../test/cases_3/e09.c
Loaded: /opt/homebrew/Cellar/spim/9.1.24/share/exceptions.s
92
0
0
```

ä½†æ˜¯æˆ‘æœ¬åœ°çš„æƒ…å†µæ˜¯e09 workï¼Ÿï¼Ÿ


## å®éªŒå››

### æ–°åŠŸèƒ½

- æ”¯æŒåˆ†æ”¯å’Œå¾ªç¯å…³é”®å­—ï¼šif, else, while, continue, break
- æ”¯æŒæ¡ä»¶è¯­å¥ï¼Œåˆ†æ”¯è¯­å¥
    - æ¡ä»¶è¯­å¥ if ( condition6 ) { ... }
    - if ( condition6 ) { ... } else { ...  }
    - å¾ªç¯è¯­å¥ while ( condition) { ... }
    - å¾ªç¯æ§åˆ¶è¯­å¥ continue; break;
- MISC: ä¼˜åŒ–ï¼Ÿ




